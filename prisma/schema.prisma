// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

enum CandidateStatus {
  SOURCED
  CONTACTED
  INTERVIEWED
  OFFERED
  HIRED
  REJECTED
}

enum InterviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum InterviewType {
  TECHNICAL
  BEHAVIORAL
  DOMAIN_EXPERT
  LANGUAGE
  CASE_STUDY
}

// ============================================
// Core Models
// ============================================

model Recruiter {
  id              String      @id @default(uuid())
  supabaseUserId  String?     @unique
  name            String
  email           String      @unique
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  candidates      Candidate[]
  interviews      Interview[] @relation("ScheduledByRecruiter")
}

model Candidate {
  id               String          @id @default(uuid())
  fullName         String
  email            String?
  phone            String?
  linkedinUrl      String?
  profileImage     String?
  currentTitle     String?
  currentCompany   String?
  skills           Json            @default("[]")
  experienceYears  Int?
  industries       Json            @default("[]")
  resumeText       String?         @db.Text
  resumeUrl        String?
  status           CandidateStatus @default(SOURCED)
  recruiterId      String
  recruiter        Recruiter       @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  embedding        Json?
  aiSummary        String?         @db.Text
  experiences      Json?
  education        Json?
  headline         String?
  location         String?
  notes            Note[]
  matches          Match[]
  interviews       Interview[]

  // Aria interview flags
  ariaInterviewed  Boolean         @default(false)
  ariaOverallScore Float?

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([recruiterId])
  @@index([status])
  @@index([ariaInterviewed])
}

model Note {
  id              String    @id @default(uuid())
  content         String    @db.Text
  isPrivate       Boolean   @default(true)
  candidateId     String
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  authorId        String

  // Activity tracking fields
  callAnswered    Boolean?
  voicemailLeft   Boolean?
  smsSent         Boolean?
  emailSent       Boolean?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([candidateId])
}

model Client {
  id               String   @id @default(uuid())
  name             String
  industry         String?
  funding          String?
  companySize      String?
  logoUrl          String?
  website          String?
  description      String?  @db.Text
  linkedinUrl      String?
  linkedinId       String?
  companyLogoCdnUrl String?
  employeeCount    Int?
  foundedYear      Int?
  headquarters     String?
  specialties      Json?
  roles            Role[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Role {
  id              String   @id @default(uuid())
  title           String
  location        String?
  salaryRange     String?
  skillsRequired  Json     @default("[]")
  description     String   @db.Text
  experienceYears String?
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  embedding       Json?
  matches         Match[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
}

model Match {
  id          String    @id @default(uuid())
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  roleId      String
  role        Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  fitScore    Float
  reasoning   String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([candidateId, roleId])
  @@index([candidateId])
  @@index([roleId])
  @@index([fitScore])
}

// ============================================
// Aria AI Interview System
// ============================================

model Interview {
  id              String            @id @default(uuid())
  candidateId     String
  candidate       Candidate         @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  scheduledBy     String
  recruiter       Recruiter         @relation("ScheduledByRecruiter", fields: [scheduledBy], references: [id])
  status          InterviewStatus   @default(PENDING)
  type            InterviewType     @default(TECHNICAL)
  duration        Int?              // duration in seconds
  startedAt       DateTime?
  completedAt     DateTime?

  // Gemini AI session data
  geminiSessionId String?
  transcript      Json?             // [{role, content, timestamp}]
  videoUrl        String?
  audioUrl        String?

  // Composite score (denormalized from report)
  overallScore    Float?

  // Detailed report (1:1)
  report          InterviewReport?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([candidateId])
  @@index([scheduledBy])
  @@index([status])
}

model InterviewReport {
  id              String    @id @default(uuid())
  interviewId     String    @unique
  interview       Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  // Per-skill ratings (micro1-style)
  // [{skill: string, rating: 0-10, description: string, evidence: string}]
  technicalSkills Json

  // Soft skills assessment
  // [{skill: string, rating: 0-10, description: string}]
  softSkills      Json

  // Dimension scores (mercor-style, 0-100)
  domainExpertise     Float?
  clarityStructure    Float?
  problemSolving      Float?
  communicationScore  Float?
  measurableImpact    Float?

  // AI-generated narrative
  summary         String    @db.Text   // Executive summary for recruiters
  strengths       Json                 // [string]
  areasToImprove  Json                 // [string]
  recommendation  String?              // STRONG_YES | YES | MAYBE | NO | STRONG_NO
  hiringAdvice    String?   @db.Text   // Detailed guidance for recruiter

  // Integrity / proctoring (future)
  integrityScore  Float?
  integrityFlags  Json?               // [{type, description, timestamp}]

  createdAt       DateTime  @default(now())
}
